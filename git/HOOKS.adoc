= Git Hooks - S√©curit√© des d√©p√¥ts
Dhrions
Version 1.0.0, 14/01/2026
:sectnums:
:toc:
:toclevels: 3
:toc-title: Table des mati√®res

== Vue d'ensemble

Ce document explique le syst√®me de hooks Git mis en place pour pr√©venir les commits accidentels de fichiers sensibles dans tous les d√©p√¥ts.

== Hook Git global pre-commit

=== Installation

Un hook `pre-commit` global est install√© et configur√© :

[source,bash]
----
# Localisation
~/.git-hooks/pre-commit

# Configuration globale
git config --global core.hooksPath ~/.git-hooks
----

=== Fonctionnement

Le hook s'ex√©cute **avant chaque commit** sur tous les d√©p√¥ts (locaux ou via Claude Code).

Il bloque les commits contenant les fichiers/patterns sensibles suivants :

[cols="1,3"]
|===
| Pattern | Description

| `.vscode/` | Configuration VS Code locale
| `.env` | Fichiers d'environnement
| `.env.*` | Variantes (.env.local, .env.prod, etc.)
| `credentials` | Fichiers de credentials
| `secrets` | Fichiers secrets
| `.pem` | Certificats/cl√©s priv√©es
| `.key` | Cl√©s priv√©es
| `id_rsa` | Cl√© SSH RSA
| `id_ed25519` | Cl√© SSH Ed25519
| `.vault_pass` | Mots de passe Ansible Vault
| `.swp` | Fichiers swap Vim
| `.swo` | Fichiers swap Vim (ancienne version)
| `~$` | Fichiers backup
|===

=== Exemple de blocage

[source,bash]
----
$ git add .env && git commit -m "fix: update config"

üö´ COMMIT BLOCKED - Sensitive files detected:
‚ùå Environment files: .env

Fix: git restore --staged <file>  # to unstage
     echo '<pattern>' >> .gitignore  # to ignore
----

=== D√©blocage

Si un fichier est bloqu√© √† tort, deux solutions :

1. **Unstager le fichier** (recommand√© si c'est sensible) :
+
[source,bash]
----
git restore --staged <fichier>
----

2. **L'ajouter √† .gitignore** (si ce sont des fichiers temporaires/locaux) :
+
[source,bash]
----
echo '.vscode/' >> .gitignore
git commit -m "chore: add .vscode to gitignore"
----

== Hook Claude Code pre-commit

=== Configuration

Quand Claude Code cr√©e des commits, un hook de validation suppl√©mentaire s'ex√©cute :

[source,text]
----
~/.claude/settings.json
  ‚Üì
  hooks.PreToolUse
    ‚Üì
    ~/.claude/hooks/pre-commit-validator.sh
----

=== Objectif

Fournir une couche de s√©curit√© suppl√©mentaire lors des commits effectu√©s par l'assistant IA Claude.

Effectue les m√™mes v√©rifications que le hook Git natif, en plus de :
- Validation des patterns sensibles d√©tect√©s
- Messages d'erreur d√©taill√©s
- Blocage du commit si violation

== Bonnes pratiques

=== 1. Toujours utiliser .gitignore

Pour chaque fichier local/sensible, ajouter au `.gitignore` du d√©p√¥t :

[source,gitignore]
----
# VS Code
.vscode/

# Environnement
.env
.env.local
.env.*.local

# Secrets
secrets/
credentials/

# SSH / Certificats
*.pem
*.key
id_rsa
id_ed25519

# Temporaires
*.swp
*.swo
*~
----

=== 2. Utiliser des fichiers d'exemple

Pour les fichiers de configuration sensibles, cr√©er des templates sans donn√©es r√©elles :

[source,bash]
----
# .env.example ou .env.template
DATABASE_URL=postgresql://localhost/mydb
API_KEY=your-key-here
SECRET_KEY=your-secret-here
----

=== 3. V√©rifier avant de commiter

[source,bash]
----
# Voir tous les fichiers stag√©s
git diff --cached --name-only

# Voir le contenu des fichiers stag√©s
git diff --cached

# Unstager un fichier sp√©cifique
git restore --staged <fichier>
----

== D√©pannage

=== "COMMIT BLOCKED - Sensitive files detected"

*Cause* : Un fichier sensible a √©t√© ajout√© au staging.

*Solution* :

[source,bash]
----
# 1. Voir les fichiers bloqu√©s
git diff --cached --name-only

# 2. Unstager les fichiers sensibles
git restore --staged <fichier>

# 3. Ajouter le pattern √† .gitignore
echo '<pattern>' >> .gitignore

# 4. Recommiter
git commit -m "message"
----

=== Le hook ne bloque rien mais devrait

Si le hook semble inactif :

[source,bash]
----
# V√©rifier la configuration
git config --get core.hooksPath

# Doit afficher : /home/<user>/.git-hooks

# Si absent, reconfigurer
git config --global core.hooksPath ~/.git-hooks

# V√©rifier les permissions du hook
ls -la ~/.git-hooks/pre-commit
# Doit avoir l'ex√©cution : -rwxr-xr-x
----

== Maintenance

=== Mettre √† jour les patterns bloqu√©s

√âditer `~/.git-hooks/pre-commit` pour ajouter/modifier les patterns d√©tect√©s.

Exemple d'ajout d'un nouveau pattern (fichiers .tfstate Terraform) :

[source,bash]
----
# Dans la d√©claration PATTERNS
declare -A PATTERNS=(
  # ... patterns existants ...
  ["\.tfstate$"]="Terraform state files"
)
----

=== Tester le hook

[source,bash]
----
# Cr√©er un d√©p√¥t de test
cd /tmp && mkdir test-hook && cd test-hook && git init

# Cr√©er un fichier sensible
echo "SECRET=123" > .env

# Essayer de le commiter
git add .env
git commit -m "test"

# Devrait √™tre bloqu√©
----

== Ressources

- link:README.adoc[Documentation Git g√©n√©rale]
- link:forges-git.adoc[Forges Git (GitHub, Gitea, etc.)]
- https://pre-commit.com/[Documentation pre-commit framework]
